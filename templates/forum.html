<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forum</title>
    <link rel="stylesheet" href="../style/PostPage.css">
</head>

<body>
    <header class="name">
        <div class="header">
            Welcome {{.Currenuser}}
            <form action="/logout" method="post">
                <button type="submit" class="bttn">Log Out</button>
            </form>
        </div>
        <br>
        <div class="temp" id="temp">
            <div class="creation">
                <a href="/create_post?postid={{.Post_id}}&user={{.Currenuser}}"><button class="bttn" id="Create">Create
                        Post</button></a>
            </div>
            <form action="/forum" method="get">
                <div class="filter">
                    <label for="all">All</label>
                    <input type="radio" name="categories" id="all" value="all">
                    <label for="sport">Sport</label>
                    <input type="radio" name="categories" id="sport" value="sport">
                    <label for="politic">Politic</label>
                    <input type="radio" name="categories" id="politic" value="politic">
                    <label for="enteairtement">Enteairtement</label>
                    <input type="radio" name="categories" id="enteairtement" value="enteairtement">
                    <label for="economie">Economie</label>
                    <input type="radio" name="categories" id="economie" value="economie">
                    <label for="it">IT</label>
                    <input type="radio" name="categories" id="it" value="it">
                    <label for="myposts">My Own Posts</label>
                    <input type="radio" name="categories" id="myposts" value="myposts">
                    <label for="likedposts">The Posts That I Liked</label>
                    <input type="radio" name="categories" id="likedposts" value="likedposts">
                    <pre>    </pre>
                    <button type="submit" class="bttn" id="filter">Filter</button>
                </div>
            </form>
        </div>
    </header>
    <h2 style="text-align: center;">Check the Newest Of your FEED!</h2>
    {{if not .Posts}}
    <h1>No Posts Available!</h1>
    {{end}}
    {{range .Posts}}
    <div class="postcontainer">
        <div class="user_info">
            <img src="/style/programmer.png" alt="{{.Usernamepublished}}">
            <h2>{{.Usernamepublished}}</h2>
        </div>
        <span id="temps">{{.Time}}</span> ago
        <h1>Title: {{.Title}}</h1>
        <p> content : {{.Body}}</p>
        <div class="reactions-container">
            <input id="postidValue" type="hidden" name="postid" value="{{.Postid}}">
            <form id="like_post"
                action="/PostsLikes?Liked_Post_id={{.Postid}}&user_id={{.CurrentUser_id}}&user={{.CurrentUsser}}"
                method="post">

                <!-- <label>üëç</label> -->
                <button type="submit" class="react" name="reaction" value="like">üëç {{.LikesCounter}}</button>

            </form>
            <form id="dislike_post"
                action="/PostsDislikes?Disliked_Post_id={{.Postid}}&user_id={{.CurrentUser_id}}&user={{.CurrentUsser}}"
                method="post">

                <!-- <label>üëé</label> -->
                <button type="submit" class="react" name="reaction" value="dislike">üëé {{.DislikeCounter}}</button>

            </form>
        </div>
        <div class="comment_container">
            <form action="/create_comment?postid={{.Postid}}&writer={{.CurrentUsser}}" method="post">
                <br>
                <div class="bb">
                    <textarea name="comments" id="comments" placeholder="Add your comments..."></textarea>
                    <br>
                    <button type="submit" class="bttn" id="comment">Comment</button>
                </div>
            </form>
            <br>
        </div>
        <form action="/showcomments" method="get" class="jj">
            <input type="hidden" value="{{.Postid}}" name="postid">
            <input type="hidden" value="{{.CurrentUsser}}" name="writer">

            <button type="submit" class="href">See All Comments()</button>
        </form>
    </div>
    {{end}}
</body>
<script>
    const comment = document.getElementsByClassName("bttn")
    const reactions = document.getElementsByClassName("react")
    const create = document.getElementById("Create")
    function getCookie(cname) {
        let name = cname + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }
    let username = getCookie("guest_token");
    console.log(username);

    if (username == "guest") {
        create.disabled = true
        for (let cm of comment) {
            // console.log(cm)
            cm.disabled = true
        }
        for (let rea of reactions) {
            rea.disabled = true
        }
    }

    const times = document.querySelectorAll('#temps')
    times.forEach(ele => ele.innerHTML = timeAffi(ele.textContent));
    function timeAffi(time) {
        let now = new Date()
        let then = new Date(time)
        let min = ((now - then) / (1000 * 60)).toFixed()
        let hours = ((now - then) / (1000 * 3600)).toFixed()
        let days = ((now - then) / (1000 * 3600 * 24)).toFixed()
        if (min < 60) {
            return min + " minutes"
        } else if (hours < 24) {
            return hours + " hours"
        } else {
            return days + " day"
        }
    }
    const CreateButton = document.getElementById('Create')
    const HiddenDiv = document.getElementById('temp')

    const commentForms = document.querySelectorAll(".comment_container form")
    commentForms.forEach(cForm => {
        cForm.addEventListener("submit", (e) => {
            e.preventDefault()
            const path = e.currentTarget.getAttribute("action")
            const formData = new FormData(e.currentTarget)
            fetch(path, {
                method: "post",
                body: formData
            })
            e.currentTarget.querySelector("textarea").value = ""
            const div = document.createElement("div")
            div.innerHTML = `<div style="color:green;"><p>Comment Added Succesfully!</p></div>`
            cForm.appendChild(div)
            setTimeout(() => {
                div.remove()
            }, 2000)
        })
    })





    const Forms = document.querySelectorAll(".reactions-container form");
    Forms.forEach(Form => {
        Form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const button = e.currentTarget.querySelector('button');
            const choice = e.currentTarget.getAttribute('id')
            let TheOtherButton = ""
            if (choice == "like_post") {
                TheOtherButton = (e.currentTarget.parentElement.querySelector('#dislike_post').querySelector('button'))
            } else {
                TheOtherButton = (e.currentTarget.parentElement.querySelector('#like_post').querySelector('button'))
                console.log("TheOtherButton2", TheOtherButton)
            }


            if (!button) {
                console.error("Button not found");
                return;
            }

            let path1 = e.currentTarget.getAttribute('action');

            let icon = button.textContent.split(' ')[0];
            let icon2 = TheOtherButton.innerHTML.split(' ')[0];
            // console.log("icon2", icon2)
            let previouslike = button.textContent.split(' ')[1];
            console.log("previouslike outside ===>", previouslike)
            const postid = e.currentTarget.parentElement.querySelector('input').value;

            try {
                await fetch(path1, {
                    method: "POST",
                });

                const path = `/api/likes?postid=${postid}`;

                const response = await getdata(path);
                const likeCount = response.LikeCount;
                const DislikeCount = response.DislikeCount;

                if (choice == "like_post") {
                    button.textContent = icon + " " + likeCount;
                    TheOtherButton.textContent = icon2 + " " + DislikeCount
                    button.style.backgroundColor = "green"
                    // if (previouslike == previouslike - 1) {
                    //     console.log("previouslike", previouslike)
                    //     TheOtherButton.style.backgroundColor = ""
                    // }
                    TheOtherButton.style.backgroundColor = ""
                } else if (choice == "dislike_post") {
                    button.textContent = icon + " " + DislikeCount;
                    TheOtherButton.textContent = icon2 + " " + likeCount
                    button.style.backgroundColor = "red"
                    TheOtherButton.style.backgroundColor = ""
                }
            } catch (err) {
                console.error("Error processing like:", err);
            }
        });
    });

    async function getdata(path) {
        try {
            const res = await fetch(path);
            if (!res.ok) {
                throw new Error(res.statusText);
            }
            const json = await res.json();
            if (json.error) {
                throw new Error(json.error);
            }
            console.log(json);
            return json;
        } catch (error) {
            console.error("Fetch error:", error);
            throw error;
        }
    }


</script>

</html>